---
createdAt: 2025-03-31_T07:52:41
literatureNote: "[[Amazon VPCを「これでもか！」というくらい丁寧に解説]]"
fleetingNote: 
tags:
  - VPS
  - AWS
---
# VPCとは

VPC = Virtual Private Cloud
	→クラウド上に仮想的なネットワークを構築するためのサービス

# VPCのメリット

AWSでは独自ネットワークを構築しなくても個別の通信が可能
	→この方式ではセキュリティ、性能面で制御が難しい
これに対しVPCを利用することで
- 通信経路を絞って監視、アクセス制御を行うことでセキュリティを向上
- 通信経路を明示的に制御してロードバランサ等でスケールアウトすることで性能を担保
- 通信経路を明示的に複数確保することで可用性を向上
- システム内のサービスを整理して一括管理することで、運用・保守性を向上
- IcCサービスと組み合わせることで移行性を向上
→非機能案件の担保につながる

# VPCの役割

非機能案件(IPA定義)
- 可用性 → 必要な時にいつでもサービスが提供、停止していない
- 性能・拡張性 → 必要な速度が確保されている&利用者が増えても拡張できる
- 運用・保守性 → 運用監視や問題発生時の対応を適切に行える
- 移行性 → 新環境への移行の容易性
- セキュリティ → 不正アクセスを防止する
- システム環境・エコロジー → システムの設置環境や、自然環境に与える影響

# オンプレにおけるネットワーク設計の難しさ

上記要件を満たすために、高度なネットワーク機器の知識、機器を揃えるためのコストが必要となる

EX.) 可用性の向上のためにサーバ、回線を冗長化した上で自動でバックアップに切り替えるための設定(リンクアグリゲーション等)を実施する必要がある

# AWSのネットワーク設計上のメリット

可用性,セキュリティ向上のための施策がデータセンターに組み込まれている
→デフォルト状態でもある程度高い非機能要件が確保

加えて非機能要件を向上させるためのサービスが多数準備されている
→組み合わせるだけで高度な非機能要件も実現可能

**専門機器の購入,ハードの知識が不要
→小規模組織でも適切な非機能要件を実現しやすい**

VPC:これらのサービスどうしをネットワークでつなぐ基盤となるため正しい知識の会得は不可欠

# AWSにおけるネットワーク関連サービス

| サービス名            | 非機能要件                     | 概要                                                                    |
| ---------------- | ------------------------- | --------------------------------------------------------------------- |
| ELB              | 可用性</br>性能・拡張性            | ロードバランサによる過負荷防止                                                       |
| Cloud Front      | 可用性 </br>性能・拡張性           | [[CDN]]によるアクセス速度向上と過負荷防止                                              |
| Route 53         | 可用性</br>性能・拡張性</br>セキュリティ | [[ヘルスチェック]]による可用性向上,[[DNSラウンドロビン]]による拡張性向上,[[DNSファイアウォール]]によるセキュリティ向上 |
| Network Firewall | セキュリティ                    | サブネットに対するアクセスルールを設定する                                                 |
| WAF              | セキュリティ                    | Webアプリに対する一般的な攻撃パターンをブロックする                                           |
| Direct Connect   | セキュリティ                    | 専用線接続によるセキュリティ向上                                                      |

# VPCの仕組みと主要機能

## ネットワークの基礎知識

### IPアドレス

| 階層  | 名称        | 通信相手の識別に使用する情報 |
| --- | --------- | -------------- |
| 第7層 | アプリケーション層 | プロトコルによりことなる   |
| 第4層 | トランスポート層  | ポート番号          |
| 第3層 | ネットワーク層   | IPアドレス         |
| 第2層 | データリンク層   | MACアドレス        |
| 第1層 | 物理層       | 物理的な接続         |
※第5層(セッション層),第6層(プレゼンテーション層)はTCP/IPではアプリケーション層と一体化されるため省略

### IPアドレスの構造

32ビットの数値で表されるIPv4と128ビットの数値で表されるIPv6が存在

### Global IP, Private IP

#### Global IP Address
	世界中で一意に定められるIPアドレスで、インターネット経由でのアクセスに用いられる。
	AWSにおいてはパブリックIPアドレスとも。

#### Private IP Address
	限られた範囲内で用いられ、その範囲内のみ一意に定める必要がある(範囲外では重複が許される)IPアドレス

### ネットワーク部とホスト部

32BitのIPv4アドレスであれば、上位XBitのネットワーク部と下位32-XBitのホスト部に分かれる

EX.) 192.168.1.2

|       | 10進数表記      | 2進数表記                               |
| ----- | ----------- | ----------------------------------- |
| IP全体  | 192.168.1.2 | 11000000 10101000 00000001 00000010 |
| NW部   | 192.168.1   | 110000001010100000000001            |
| Host部 | 2           | 00000010                            |

ネットワーク部を1、ホスト部を0Bit表記したものをサブネットマスクという。

EX.) ネットワーク部が24Bitであれば、サブネットマスクは
	255.255.255.0(11111111 11111111 11111111 00000000)

ネットワーク部の長さは、サブネットマスク長,プレフィックス長と呼ばれる。
ホスト部をすべて0で埋めたアドレスはネットワークアドレスと呼ばれ、サブネット自身を表すアドレスとして使用される。

### サブネット

通常、プライベートIPアドレスのプレフィックス長が クラスA~Cの固定値(8,16,24Bit)が使用される。
→3通りのプレフィックス長しか使用できないため、ホスト数によってはアドレス空間が大量に余ってしまい、無駄の多いネットワークとなってしまう。

⇒3通り以外のプレフィックス長が動的に設定できるようにしたCIDR(Classless Inter-Domain Routing)と呼ばれる機構が広く使われている

#### CIDR記法
192.168.1.2のNW部が26Bitであればネットワークアドレスは192.168.1.0/26と表す。

### 使用可能なIPアドレス

ICANNによって使用できるアドレス範囲が定められている。
VPCのプライベートIPアドレスとして使用できるのは、以下ClassA,B,Cのアドレス範囲のみである。

| IPアドレス範囲                         | 用途                                                 |
| -------------------------------- | -------------------------------------------------- |
| 127.0.0.0~</br>127.255.255.255   | [[ループバックアドレス]](自分自身を指すアドレス)                        |
| 169.254.0.0~</br>169.254.255.255 | [[リンクローカルアドレス]](ルータを使用せずにアクセスするためのアドレス)            |
| 224.0.0.0~</br>239.255.255.255   | [[マルチキャストアドレス]](あらかじめ定められたルールで複数のアドレスに同時送信する際に使用。) |
| 255.255.255.255                  | 制限ブロードキャストアドレス                                     |
| 10.0.0.0~</br>10.255.255.255     | プライベートアドレス(ClassA=プレフィックス長8Bit)                    |
| 172.16.0.0~</br>172.31.255.255   | プライベートアドレス(ClassB=プレフィックス長16Bit)                   |
| 192.168.0.0~</br>192.168.255.255 | プライベートアドレス(ClassC=プレフィックス長24Bit)                   |
| 上記以外                             | グローバルアドレス等                                         |

AWSにおいて、以下のホスト部はAWS側で利用されているため、新たにホストに設定することはできない

| ホスト部   | 用途                 | NWアドレスが10.0.0.1/28の時の例 |
| ------ | ------------------ | ---------------------- |
| 0      | NWアドレスを表す          | 10.0.1.0               |
| 1      | VPCルータ             | 10.0.1.1               |
| 2      | Amazonが提供するDNSサービス | 10.0.1.2               |
| 2      | AWSで予約されているアドレス    | 10.0.1.3               |
| 全ビットが1 | ブロードキャストアドレス       | 10.0.1.15              |

### NAT

#### NAT(Network Address Translation)

グローバルIPアドレスとプライベートIPアドレスを変換する機能。
通常インターネット上からプライベートIPアドレスにアクセスすることはできない
→NATを使用することによりグローバルIPアドレス向けに届けられたパケットの宛先をプライベートIPアドレスが設定されたホストにアクセスさせることができる。

#### NAPT(Network Address Port Translation)

多くの一般家庭ではグローバルIPアドレスは1個しか振り分けられない。
→NATでは1個のプライベートIPアドレスしかインターネットからアクセスできない
⇓
NAPTを使用することで1個のグローバルIPアドレスに複数のプライベートIPアドレスを紐づけられる。

**NAT,NAPTをあわせて広義のNATと呼ぶこともある。**

### ルーティング

サブネットの結節点において、他のサブネットとの通信経路を決定する制御。

自サブネット以外との通信にはリーティングが必須となる
→複数のサブネットが存在するネットワークにおいては必須の技術

#### ルーティングテーブル

ルーティングのルールを定めるテーブル
宛先IPアドレスとルーティングテーブルに基づいてどのサブネットにパケットが送信されるかが決定される。

##### 静的ルーティング
	IPアドレスに基づいて毎回同じ経路が選択される
##### 動的ルーティング
	動的に経路が決定される

VPCでは基本的に静的ルーティングを使用する。(VPN,トランジットゲートウェイ使用時はBGPによる動的ルーティングでオンプレネットワークと連携することもある。)

#### ルーティングテーブルの見方

ロンゲストマッチアルゴリズムに基づいてパケットの送信先を決定する。
→送信したい宛先IPアドレスとルーティングテーブルの宛先ルート(一般的に複数登録されている)を比較し、**宛先アドレスをサブネット内に含む宛先ルートの中で、最もプレフィックス長が長いものを選択**する手法。

選択された宛先ルートと同一行を参照し、主にインターフェイスとネクストホップからパケットの送信先が決定される。

#### オンプレとVPCのルーティングの違い

オンプレネットワークにおいてはサブネット間の結節点である「ルータ」がルーティングを実施する。
VPCにおいては「ルートテーブル」というサービスを使用することでサブネットごとにルーティングを制御できる。

VPCではルータ同士の物理的な位置関係や動的ルーティングを考慮しなくても良い
→オンプレよりもシンプルなルーティングを実現できる

### DHCP(Dynamic Host Configulation Protocol)

ホストにネットワーク関係の情報を渡すためのプロトコル

一般的にはホストにプライベートIPアドレスを動的に割り振る際に使用する
+DNSサーバのIPアドレス、デフォルトゲートウェイのIPアドレス等の情報がホストに渡される。

業務向けシステムではDHCP機能を実現するDHCPサーバが置かれることが一般的だが、一般家庭で使用されるルータにもDHCP機能が標準装備されていることが多く、特別な設定をしなくてもプライベートIPアドレスが割り振られてネットワーク通信ができる。

VPCにおいてもElastic IPを使用しない限り、このDHCP機能が働き、VPC内部のインスタンスのIPアドレスは動的に割り振られる(再起動でIPアドレスが変わる。)

DHCPオプションセットは本来のDHCPの主機能であるIPアドレスの振り分けには使用されず、DNSサーバやNTPサーバ等の情報をホストにわたす機能のみを持つ。

### 外向き通信,内向き通信

- 外向き通信
	内部ネットワーク(VPC等)からインターネット方向への通信
- 内向き通信
	インターネットから内部ネットワークへの通信

TCP通信では基本的に要求と応答がせって